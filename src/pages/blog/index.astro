---
import Base from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { formatDateWithOrdinal } from '../../utils/date';

const posts = (await getCollection('blog')).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

// Pre-process all posts to get their previews
const postsWithPreviews = posts.map((post) => {
  let preview = post.body
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Replace [text](url) with text
    .replace(/!\[([^\]]*)\]\([^)]+\)/g, '') // Remove images ![alt](url)
    .replace(/\s+/g, ' ') // Normalize whitespace
    .trim();

  preview = preview.length > 220 ? preview.slice(0, 219) + 'â€¦' : preview;
  return { ...post, preview };
});
---

<Base title="Blog">
  <h1>Blog</h1>
  <p class="muted">Thoughts on AI, engineering, and more.</p>

  <ul class="post-list">
    {
      postsWithPreviews.map((post) => (
        <li class="post-item">
          <a href={`/blog/${post.slug}`} class="post-link">
            <h2 class="post-title">{post.data.title}</h2>
            <p class="post-subtitle">{post.data.subtitle}</p>
            <p class="post-meta">
              {formatDateWithOrdinal(post.data.date)}
              <span class="post-tags">
                {post.data.tags.map((tag) => (
                  <span class="tag">{tag}</span>
                ))}
              </span>
            </p>
            <p class="post-preview">{post.preview}</p>
          </a>
        </li>
      ))
    }
  </ul>
</Base>

<style>
  .post-list {
    list-style: none;
    margin: 2rem 0 0 0;
    padding: 0;
    width: 100%;
  }

  .post-item {
    border-bottom: 1px solid #2a3445;
  }

  .post-item:first-child {
    border-top: 1px solid #2a3445;
  }

  .post-link {
    display: block;
    color: inherit;
    text-decoration: none;
    padding: 1rem 0;
    width: 100%;
  }

  .post-title {
    margin: 0 0 0.25rem 0;
  }

  .post-subtitle {
    margin: 0 0 0.5rem 0;
    color: var(--muted);
  }

  .post-meta {
    margin: 0 0 0.75rem 0;
    color: var(--muted);
    font-size: 0.9rem;
  }

  .post-preview {
    margin: 0;
    color: var(--text);
    line-height: 1.6;
  }
</style>
